<!DOCTYPE html>
<html>
  <head>
    <title>New Haven Report Card</title>
    <link href='css/bootstrap.min.css' rel='stylesheet'>
    <link href='css/main.css' rel='stylesheet'>
    <link href='css/stylesheet.css' rel='stylesheet'>

    <script src="Chart.min.js"></script>
  </head>

  <!-- body -->
  <body>
    <div class='navbar navbar-default navbar-static-top'>
      <div class='container'>
        <a href='/nhrc' class='navbar-brand'>New Haven Report Card</a>

        <ul class='nav navbar-nav navbar-right'>
          <li><a href='http://seeclickfix.com' target='new'>Dashboard</a></li>
          <li><a href='http://seeclickfix.com' target='new'>Pothole Evolution</a></li>
          <li><a href='http://seeclickfix.com' target='new'>See Click Fix</a></li>
          <li><a href='chart.html'>Chart</a></li>
        </ul>
      </div>
    </div>
<!-- end of navbar -->

<!-- beginning of main content -->

<!--
<div class="col-md-6">
  <div class="project-certification"></div>
    <div class="simple-bars-wrapper">
      <div class="vertical-separator"></div>      
    </div>
</div>
-->

<div class="col-md-12">
 <canvas id="myChart" style="width: 100%; height: 100%"></canvas>
</div>
            </div>
<!-- footer section -->

<div class="container">
  <div class="row spacer-bottom"></div>
</div>


<!-- footer -->
<div class='footer navbar navbar-fixed-bottom'>
  <div class='container'>
    <div class='row'>
      
    </div>
  </div>
</div>


    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script src='js/bootstrap.min.js'></script>
    <script src='js/moment.min.js'></script>
    <script src='js/d3.min.js'></script>
    <script src='js/d3.legend.js'></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src='js/jquery.csv-0.71.min.js'></script>
<!--    <script src='js/environ.js'></script> -->

    <script>
        // Get the context of the canvas element we want to select
        

        

        function numDateIsIn(data, startDate, endDate, colNum) {
            var n = 0;
            for (i in data) {
                var row = data[i];
                var date = moment(row[colNum]);
                // console.log("startDate: " + startDate);
                // console.log("curret date: " + date._d);
                // console.log("endDate: " + endDate);

                if (date <= endDate && date >= startDate) {
                    n += 1;
                    //console.log('in range!!!!!!!!!!!!!!!');
                }
                console.log('---');
            }
            return n;
        }

        function dateIntervals(startDate, endDate, intervalNum, intervalStr) {
            var intervals = [];
            console.log('splitByInterval: ' + startDate + ' ; endDate: ' + endDate);
            var nextStartMoment = moment(startDate);
            var endMoment = moment(endDate);
            while (nextStartMoment < endMoment) {
                var intervalStartDate = nextStartMoment._d;
                var intervalEndDate = moment(intervalStartDate).add(intervalNum, intervalStr)._d;
                intervals.push(intervalStartDate);
                console.log('iteration');
                nextStartMoment = moment(intervalEndDate);
            }
            return intervals;
        }

        function splitByInterval(data, startDate, endDate, intervalNum, intervalStr, colNum) {
            console.log('splitByInterval: ' + startDate + ' ; endDate: ' + endDate);
            var nextStartMoment = moment(startDate);
            var endMoment = moment(endDate);
            var numInInterval = [];
            while (nextStartMoment < endMoment) {
                var intervalStartDate = nextStartMoment._d;
                var intervalEndDate = moment(intervalStartDate).add(intervalNum, intervalStr)._d;
                numInInterval.push(numDateIsIn(data, intervalStartDate, intervalEndDate, colNum));
                console.log('iteration');
                nextStartMoment = moment(intervalEndDate);
            }
            return numInInterval;
        }

        lineData = {
                        labels: ["January", "February", "March", "April", "May", "June", "July"],
                        datasets: [
                            {
                                label: "Reported",
                                fillColor: "rgba(255,0,0,0.2)",
                                strokeColor: "rgba(255,0,0,1)",
                                pointColor: "rgba(255,0,0,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(255,0,0,1)",
                                data: [65, 59, 80, 81, 56, 55, 40]
                            },
                            {
                                label: "Acknowledged",
                                fillColor: "rgba(0,0,255,0.2)",
                                strokeColor: "rgba(0,0,255,1)",
                                pointColor: "rgba(0,0,255,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(0,0,255,1)",
                                data: [28, 48, 40, 19, 86, 27, 90]
                            },
                            {
                                label: "Closed",
                                fillColor: "rgba(0,255,0,0.2)",
                                strokeColor: "rgba(0,255,0,1)",
                                pointColor: "rgba(0,255,0,1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(0,255,0,1)",
                                data: [28, 48, 40, 19, 86, 27, 90]
                            },
                        ],
                    };

        $(document).ready(function() {
            $.ajax({
                type: "GET",
                url: "data/SCF_2014_NHV_Service_Request_Data_small.csv",
                dataType: "text",
                success: function(data) {

                    console.log(data);


                    ctx = document.getElementById("myChart").getContext("2d");

                    parsedData = $.csv.toArrays(data);
                    console.log(parsedData);
                    
                    lineData.labels = dateIntervals('2014-01-01T00:00:25-04:00', '2015-01-01T00:00:25-04:00', 1, 'month');
                    lineData.datasets[0].data = splitByInterval(parsedData, '2014-01-01T00:00:25-04:00', '2015-01-01T00:00:25-04:00', 1, 'month', 14);
                    lineData.datasets[1].data = splitByInterval(parsedData, '2014-01-01T00:00:25-04:00', '2015-01-01T00:00:25-04:00', 1, 'month', 15);
                    lineData.datasets[2].data = splitByInterval(parsedData, '2014-01-01T00:00:25-04:00', '2015-01-01T00:00:25-04:00', 1, 'month', 17);

                    var myNewChart = new Chart(ctx).Line(lineData, {
                        bezierCurve: false
                    });
                }
             });
        });


        
    </script>
  </body>
</html>